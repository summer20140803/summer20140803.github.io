---
layout:     post
title:      åˆ¶ä½œAPIæ—¥å¿—é˜…è¯»å™¨
date:       2017-08-15
author:     å¼€ä¸äº†å£çš„çŒ«
header-img: img/icon_make_api_record_viewer_bg.jpg
catalog: true
tags:
    - iOS
    - API
---

## å‰è¨€
å½“æˆ‘ä»¬ç”¨æ‰‹æœºè¿æ¥Xcodeæˆ–ç›´æ¥æ‰“å¼€Xcodeçš„æ¨¡æ‹Ÿå™¨è¿›è¡ŒAPIè¯·æ±‚è°ƒè¯•æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Xcode`Console`å®æ—¶æŸ¥çœ‹è¾“å‡ºçš„APIæ—¥å¿—æ¥å®šä½æ•°æ®é—®é¢˜ï¼Œè‡ªä¸å¿…è¯´ï¼Œè¿™ç®—æ˜¯iOSç¨‹åºçŒ¿çš„å¸¸è§„æ“ä½œã€‚è®©æˆ‘ä»¬æƒ³è±¡å¦ä¸€ä¸ªåœºæ™¯ï¼Œåœ¨æµ‹è¯•å†’çƒŸé˜¶æ®µæˆ‘ä»¬æ‹¿åˆ°äº†ä¸€å°æµ‹è¯•çœŸæœºï¼Œä½ è¢«æŠ±æ€¨åˆ°xxxæ¨¡å—çš„ä¸šåŠ¡æ•°æ®æ˜¾ç¤ºå¼‚å¸¸ï¼Œä¸ºäº†æé«˜å†’çƒŸæ•ˆç‡ï¼Œæµ‹è¯•å¹¶ä¸ä¼šç¬¬ä¸€æ—¶é—´å¸®ä½ é€šè¿‡æŠ“åŒ…å·¥å…·å»å®šä½æ¥å£æ•°æ®å¼‚å¸¸çš„åŸå› ï¼Œæ­¤æ—¶ï¼Œå¦‚æœç¨‹åºä¸­èƒ½æœ‰ä¸€ä¸ªå®æ—¶æŸ¥çœ‹APIæ—¥å¿—çš„é˜…è¯»å™¨ï¼Œå°±èƒ½çœå»ä½ è¿æ¥Xcodeè¿›è¡Œæ¥å£è°ƒè¯•çš„ä¸€ç³»åˆ—æ“ä½œäº†ã€‚  

`APIæ—¥å¿—é˜…è¯»å™¨`ä½œä¸ºå­å·¥å…·ç»„ä»¶å·²è¢«é›†æˆåˆ°[iOSçœŸæœºæ¡Œé¢çº§è°ƒè¯•å·¥å…·](https://github.com/summer20140803/TDFScreenDebugger)ä¸­ï¼Œå¯ä»¥ç›´æ¥cloneæˆ–é€šè¿‡Cocoapodsé›†æˆï¼Œæ¬¢è¿StarğŸ¤“

## é˜…è¯»å™¨çš„è®¾è®¡
æ€æ ·è®¾è®¡ä¸€ä¸ªAPIæ—¥å¿—é˜…è¯»å™¨æ›´ä¸ºäººæ€§åŒ–å‘¢ï¼Ÿæˆ‘è®¤ä¸ºéœ€è¦æ»¡è¶³ä»¥ä¸‹ç‰¹ç‚¹ã€‚
* é˜…è¯»å™¨çš„æ˜¾ç¤º/éšè—äº¤äº’æ–¹å¼åº”è¯¥æ›´ä¸ºä¾¿æ·
* å¯¹äºAPIè¯·æ±‚å’Œå“åº”æ—¥å¿—åº”è¯¥é€šè¿‡ä¸åŒé¢œè‰²åŒºåˆ†å¼€æ¥ï¼Œå¤±è´¥çš„å“åº”æ—¥å¿—ä¹Ÿåº”è¯¥ä¸æˆåŠŸçš„å“åº”æ—¥å¿—åŒºåˆ«å¼€
* å•æ¡APIæ—¥å¿—åº”è¯¥è¢«æ ¼å¼åŒ–ä¸ºæ˜“äºé˜…è¯»çš„æ ·å¼
* é˜…è¯»å™¨çš„æ—¥å¿—æœ€å¥½èƒ½å®æ—¶æ›´æ–°è€Œä¸æ˜¯éœ€è¦æ‰‹åŠ¨åˆ·æ–°ï¼Œå¹¶ä¸”èƒ½å¤Ÿè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°çš„æ—¥å¿—çš„ä½ç½®
* é˜…è¯»å™¨åº”è¯¥å†…ç½®å…³é”®å­—æ£€ç´¢åŠŸèƒ½
* é˜…è¯»å™¨æœ€å¥½å†…ç½®ä¸€ä¸ªæ¸…ç©ºæ—¥å¿—çš„åŠŸèƒ½
* é‰´äºæŠ“åŒ…å·¥å…·çš„æ™®åŠï¼Œå¯ä»¥æä¾›ä¸€ç§å°†æ•´ä¸ªAPIä½œä¸ºå•ä½çš„åˆ—è¡¨è§†å›¾ï¼Œä»¥æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œç‚¹å‡»æŸä¸€æ¡APIåå¯ä»¥æŸ¥çœ‹å…·ä½“çš„è¯·æ±‚ä½“ä¸å“åº”ä½“

ä¸ºæ»¡è¶³ä»¥ä¸Šç‰¹ç‚¹ï¼Œåœ¨å·¦å³æ–Ÿé…Œä¹‹åï¼Œæˆ‘å†³å®šåˆ¶ä½œèƒ½æä¾›ä¸¤ä¸ªä¸åŒæ—¥å¿—è§†å›¾çš„é˜…è¯»å™¨ã€‚ä¸€ä¸ªè§†å›¾ä»¥æ—¥å¿—ä½œä¸ºè¾“å‡ºå•ä½ï¼Œå°†ä¸åŒAPIçš„è¯·æ±‚/å“åº”æ—¥å¿—è¾“å‡ºåœ¨ä¸€èµ·(å°±åƒç ”å‘äººå‘˜åœ¨Xcode`Console`æŸ¥çœ‹APIæ—¥å¿—ä¸€æ ·)ï¼Œæä¾›å…³é”®å­—æ£€ç´¢å’Œé¢œè‰²æ ‡è¯†ï¼Œæˆ‘æš‚ä¸”ç§°ä¹‹ä¸º`ç¦»æ•£å‹APIæ—¥å¿—é˜…è¯»å™¨`ã€‚è€Œå¦ä¸€ä¸ªè§†å›¾åˆ™ä»¥APIä½œä¸ºè¾“å‡ºå•ä½ï¼Œåœ¨äºŒçº§è§†å›¾å±•ç¤ºå·²æŒ‰ç…§æ—¶é—´æ’åºåçš„APIåˆ—è¡¨ï¼Œç„¶åå°±åƒåœ¨æŠ“åŒ…å·¥å…·ä¸ŠæŸ¥çœ‹APIæ—¥å¿—ä¸€æ ·ï¼Œç‚¹å‡»ä¸€ä¸ªæ„Ÿå…´è¶£çš„APIï¼Œç„¶åæŸ¥çœ‹è¯¦ç»†çš„è¯·æ±‚æ—¥å¿—å’Œå“åº”æ—¥å¿—ï¼Œæˆ‘æš‚ä¸”ç§°ä¹‹ä¸º`ç»‘å®šå‹APIæ—¥å¿—é˜…è¯»å™¨`ã€‚

## æ—¥å¿—æ•°æ®æº
é‰´äºæˆ‘ä¸Šä¸€ç¯‡æ–‡ç« è®¾è®¡ä¸å®ç°äº†APIæ—¥å¿—è¾“å‡ºå·¥å…·[TDFAPILogger](http://127.0.0.1:4000/2017/07/21/iOS-Pretty-Format-APIæ—¥å¿—æ‰“å°/)ï¼Œåœ¨åˆ¶ä½œTDFAPILoggerçš„æ—¶å€™ï¼Œæˆ‘åˆ»æ„ä¿ç•™äº†ä¸¤ä¸ªå¯¹å¤–çš„æ¥å£ç”¨äºå®æ—¶æä¾›æ ¼å¼åŒ–çš„æ—¥å¿—æ¨¡å‹ã€‚
```objc
/**
 APIè¯·æ±‚æ—¥å¿—æ±‡æŠ¥è€…ï¼Œ
 ä¼šåœ¨æ ¼å¼åŒ–å(ä¸åŒ…æ‹¬emoji)çš„è¯·æ±‚æè¿°æ¨¡å‹é€šè¿‡è¿™ä¸ªblockä¼ ç»™å¤–éƒ¨
 */
@property (nonatomic,   copy) void(^requestLogReporter)(TDFALRequestModel *requestLogDescription);

/**
 APIå“åº”æ—¥å¿—æ±‡æŠ¥è€…ï¼Œ
 ä¼šåœ¨æ ¼å¼åŒ–å(ä¸åŒ…æ‹¬emoji)çš„å“åº”æè¿°æ¨¡å‹é€šè¿‡è¿™ä¸ªblockä¼ ç»™å¤–éƒ¨
 */
@property (nonatomic,   copy) void(^responseLogReporter)(TDFALResponseModel *responseLogDescription);
```
å› æ­¤æˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªå•ä¾‹ç±»`TDFSDAPIRecorder`ï¼Œåœ¨å¯åŠ¨æ–¹æ³•`- (void)thaw`ä¸­ç›‘å¬`TDFAPILogger`çš„è¾“å‡ºçš„APIæ—¥å¿—ï¼Œå¹¶é€šè¿‡æ•°ç»„ç»“æ„å°†å®ƒä»¬ä¿å­˜ä¸‹æ¥ã€‚
```objc
- (void)thaw {
    TDFSDAPIRecorder *recorder = [TDFSDAPIRecorder sharedInstance];
    [TDFAPILogger sharedInstance].requestLogReporter = ^(TDFALRequestModel *requestLogDescription) {
        [recorder storeDescription:requestLogDescription];
    };
    [TDFAPILogger sharedInstance].responseLogReporter = ^(TDFALResponseModel *responseLogDescription) {
        [recorder storeDescription:responseLogDescription];
    };
}
```
åœ¨å†»ç»“æ–¹æ³•`freeze`ä¸­æ³¨é”€ç›‘å¬ã€‚
```objc
- (void)freeze {
    [TDFAPILogger sharedInstance].requestLogReporter = NULL;
    [TDFAPILogger sharedInstance].responseLogReporter = NULL;
}
```
PSï¼š`thaw`å’Œ`freeze`ä¸º`TDFScreenDebugger`ç»„ä»¶ä¸­æ‰€æœ‰å­ç»„ä»¶çš„IOåè®®æ–¹æ³•ï¼Œç”¨äºç»Ÿä¸€å®šä¹‰å­ç»„ä»¶çš„`å¯åŠ¨`å’Œ`å†»ç»“`æ“ä½œã€‚  

åŒæ ·åœ°ï¼Œ`TDFSDAPIRecorder`ä½œä¸ºæ•°æ®æºçš„ç®¡ç†è€…ä¹Ÿæä¾›äº†`æ¸…ç©ºå½“å‰æ—¥å¿—`çš„æ–¹æ³•ã€‚è€Œæ¸…ç©ºä»…ä»…æ˜¯å°†å­˜å‚¨æ—¥å¿—çš„æ•°ç»„æ¸…ç©ºè€Œå·²ã€‚
```objc
- (void)clearAllRecords {
    self.descriptionModels = @[];
    self.requestDesModels = @[];
    self.responseDesModels = @[];
}
```

## é˜…è¯»å™¨è§†å›¾åˆ‡æ¢é€»è¾‘
åœ¨ç»„ä»¶`TDFScreenDebugger`çš„ä¸»æ¡†æ¶ä¸‹ï¼Œé€šè¿‡`æ‘‡ä¸€æ‘‡æ‰‹åŠ¿`åœ¨ä¸šåŠ¡è§†å›¾ä¸æ—¥å¿—è§†å›¾ä¹‹é—´åˆ‡æ¢ï¼Œè¿™ä¸ºæˆ‘ä»¬æä¾›äº†æ¯”æŠ“åŒ…å·¥å…·æ›´ä¾¿åˆ©çš„é˜…è¯»æ–¹å¼ã€‚å…¶åŸç†æ˜¯åœ¨ç»„ä»¶å†…éƒ¨ç”³è¯·äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„windowï¼Œå°†windowçš„levelè°ƒæ•´åˆ°æ¯”è¾ƒé«˜çš„ä½ç½®ï¼Œç„¶åé€šè¿‡è¿™ä¸ªwindowçš„éšè—ä¸æ˜¾ç¤ºæ¥åˆ‡æ¢è§†å›¾ã€‚  
æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å½“é˜…è¯»å™¨éœ€è¦æ£€ç´¢å¼¹å‡ºé”®ç›˜è¾“å…¥å…³é”®å­—æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªwindowè®¾ç½®ä¸º`keywindow`æ¥å“åº”é”®ç›˜çš„äº¤äº’äº‹ä»¶ï¼Œè€Œå½“æˆ‘ä»¬åˆ‡æ¢åˆ°ä¸šåŠ¡è§†å›¾æ—¶ï¼Œåˆ™åº”è¯¥è®©ä¸šåŠ¡windowæˆä¸ºkeywindowï¼Œæˆ‘ä»¬éœ€è¦åƒè¿™æ ·å¤„ç†ã€‚
```objc
- (void)viewDidAppear:(BOOL)animated {
    [super viewDidAppear:animated];
    // apply to become keywindow for `TDFSDWindow` instance
    [[TDFSDManager manager] applyForAcceptKeyInput];
}

- (void)dealloc {
    // let `TDFSDWindow` instance gives up becoming keywindow
    [[TDFSDManager manager] revokeApply];
}
```
`TDFSDManager`ä¹Ÿæ˜¯åœ¨`TDFScreenDebugger`ä¸»æ¡†æ¶çš„æ ¸å¿ƒç±»ä¹‹ä¸€ã€‚
```objc
- (void)applyForAcceptKeyInput {
    UIWindow *keyWindow = [[UIApplication sharedApplication] keyWindow];
    
    if (keyWindow != self.screenDebuggerWindow) {
        self.originWindow = keyWindow;
        [keyWindow resignFirstResponder];
        
        self.sd_canBecomeKeyWindow = YES;
        [self.screenDebuggerWindow makeKeyWindow];
    }
}

- (void)revokeApply {
    UIWindow *keyWindow = [[UIApplication sharedApplication] keyWindow];
    
    if (keyWindow == self.screenDebuggerWindow) {
        [keyWindow resignFirstResponder];
        
        self.sd_canBecomeKeyWindow = NO;
        [self.originWindow makeKeyWindow];
    }
}
```
## å®æ—¶æ˜¾ç¤ºAPIæ—¥å¿—
åœ¨æ˜¾ç¤ºAPIæ—¥å¿—çš„ä¸»æ§åˆ¶å™¨`TDFSDAPIRecordConsoleController`ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡KVOæ¥å®æ—¶ç›‘å¬`TDFSDAPIRecorder`çš„APIæ—¥å¿—æ•°ç»„çš„å˜åŒ–å¹¶å®æ—¶æ¸²æŸ“åˆ°textViewæ§ä»¶ä¸Šï¼Œä¸ºäº†ä¾¿æ·å®ç°ï¼Œ`TDFScreenDebugger`å¼•å…¥äº†[ReactiveObjC](https://github.com/ReactiveCocoa/ReactiveObjC)æ¥å¸®æˆ‘æ›´é«˜æ•ˆåœ°å®ç°KVOã€‚
```objc
- (void)addAPIRecordPortObserve {
    RAC(self.apiOutputView, attributedText) = [[[RACObserve([TDFSDAPIRecorder sharedInstance], descriptionModels)
    skip:1]
    map:^id _Nullable(NSArray<__kindof TDFALBaseModel<TDFSDAPIRecordCharacterizationProtocol> *> *descriptionModels) {
        return [[descriptionModels.rac_sequence
               map:^id _Nullable(__kindof TDFALBaseModel<TDFSDAPIRecordCharacterizationProtocol> * _Nullable descriptionModel) {
                   
                   // mark `TDFALRequestModel` instances messageRead to YES
                   if ([descriptionModel isKindOfClass:[TDFALRequestModel class]]) {
                       [(TDFALRequestModel *)descriptionModel setMessageRead:YES];
                   }
                   return descriptionModel.outputCharacterizationString;
               }]
               foldLeftWithStart:[[NSMutableAttributedString alloc] initWithString:@""]
               reduce:^id _Nullable(NSMutableAttributedString * _Nullable accumulator, NSAttributedString * _Nullable value) {
                   return ((void)([accumulator appendAttributedString:value]),
                           (void)([accumulator appendAttributedString:[[NSAttributedString alloc] initWithString:@"\n\n"]]),
                           accumulator);
               }];
    }]
    deliverOnMainThread];
    
    @weakify(self)
    [[[[[RACObserve(self.apiOutputView, attributedText)
    skip:1]
    distinctUntilChanged]
    delay:0.2f]
    doNext:^(id  _Nullable x) {
        @strongify(self)
        if (self.loadingView.isAnimating) {
            [self.loadingView stopAnimating];
        }
    }]
    subscribeNext:^(id  _Nullable x) {
        @strongify(self)
        [self.apiOutputView scrollRangeToVisible:NSMakeRange(self.apiOutputView.attributedText.length, 1)];
        [self sendClearRemindLabelTextRequestWithContentType:SDAllReadNotificationContentTypeAPIRecord];
    }];
}
```
é€šè¿‡ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº†NSMutableAttributedStringæ¥å®ç° è¯·æ±‚æ—¥å¿—/æˆåŠŸå“åº”æ—¥å¿—/å¤±è´¥å“åº”æ—¥å¿— çš„é¢œè‰²åŒºåˆ†ï¼Œæ¸²æŸ“åå»¶è¿Ÿ0.2sæ‰§è¡Œäº†
```objc
[self.apiOutputView scrollRangeToVisible:NSMakeRange(self.apiOutputView.attributedText.length, 1)];
```
å¸®åŠ©æˆ‘ä»¬æ°¸è¿œæ»‘åŠ¨åˆ°æœ€æ–°çš„APIæ—¥å¿—çš„ä½ç½®ä¸Šã€‚

## æ·»åŠ å…³é”®å­—æ£€ç´¢åŠŸèƒ½
æˆ‘ä»¬å¯ä»¥é€šè¿‡`æ­£åˆ™è¡¨è¾¾å¼`æ£€ç´¢å‡ºAPIæ—¥å¿—ä¸­æ‰€æœ‰åŒ…å«å…³é”®çš„éƒ¨åˆ†ï¼Œç„¶åç»“åˆ`NSTextStorage`å’Œ`NSLayoutManager`å®ç°é«˜äº®æ•ˆæœã€‚ä¸ºäº†æ›´åŠ ä¾¿æ·åœ°å®ç°ï¼Œæˆ‘ä»¬å¼•å…¥äº†[ICTextView](https://github.com/IvanoBilenchi/ICTextView)ï¼Œå®ƒè¢«è®¾è®¡ä¸ºä¸€ä¸ªå¯å®šåˆ¶åŒ–çš„UITextViewå­ç±»ï¼Œå†…ç½®å®ç°äº†å…³é”®å­—æ£€ç´¢å’Œé«˜äº®åŠŸèƒ½ã€‚å…¶å†…éƒ¨é€šè¿‡ç»™æ£€ç´¢åçš„æ–‡å­—æ®µ(Rect)æ·»åŠ ä¸€å—åŠé€æ˜çš„èƒŒæ™¯UIViewï¼Œç„¶åé€šè¿‡åˆ›å»ºä¸€ä¸ªæ•°ç»„ä½œä¸ºç¼“å­˜æ± ï¼Œèƒ½è¾¾åˆ°æ¯”è¾ƒç†æƒ³çš„æ£€ç´¢æ€§èƒ½ã€‚

## ç»‘å®šå‹APIæ—¥å¿—è§†å›¾
æŒ‰ç…§ä¹‹å‰çš„è®¾è®¡ï¼Œé‰´äºæŠ“åŒ…å·¥å…·çš„æ™®åŠï¼Œæˆ‘ä»¬æœ€å¥½å¦å¤–æä¾›ä¸€ç§å°†æ•´ä¸ªAPIä½œä¸ºå•ä½çš„åˆ—è¡¨è§†å›¾ï¼Œä»¥æ—¶é—´é¡ºåºè¿›è¡Œæ’åºï¼Œç‚¹å‡»æŸä¸€æ¡APIåå¯ä»¥æŸ¥çœ‹å…·ä½“çš„è¯·æ±‚ä½“ä¸å“åº”ä½“çš„è§†å›¾ã€‚è¿™ç§è§†å›¾å¯èƒ½æ›´åŠ é’ˆå¯¹æµ‹è¯•äººå‘˜åœ¨æµ‹è¯•é˜¶æ®µè¿›è¡Œæ›´åŠ ä¾¿æ·çš„æŠ“åŒ…è¡Œä¸ºï¼Œæ—¥å¿—çš„å¯è¯»æ€§æ‰æ˜¯é‡ä¸­ä¹‹é‡ã€‚  

ç»‘å®šå‹APIæ—¥å¿—è§†å›¾çš„å®ç°æ›´ä¸ºç®€å•ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚

## æœ€ç»ˆæ•ˆæœ
ä¸è¯´åºŸè¯ï¼Œç›´æ¥ä¸Šå±å¹•å½•åˆ¶ã€‚(è§†é¢‘å¯èƒ½éœ€è¦å„ä½ç¿»ä¸ªå¢™ï¼Œæœ¬äººä¸Šä¼ çš„YoutubeğŸŒš)

<iframe width="420" height="315" src="https://www.youtube.com/embed/Ha9cC5sH8EI" frameborder="0" allowfullscreen></iframe>



