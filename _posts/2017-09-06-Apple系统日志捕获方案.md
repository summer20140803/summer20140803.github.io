---
layout:     post
title:      Appleç³»ç»Ÿæ—¥å¿—æ•è·æ–¹æ¡ˆ
date:       2017-09-06
author:     å¼€ä¸äº†å£çš„çŒ«
header-img: img/icon_Appleç³»ç»Ÿæ—¥å¿—æ•è·æ–¹æ¡ˆ_bg.png
catalog: true
tags:
    - iOS
    - Appleæ—¥å¿—
---

## å‰è¨€
ä¹‹å‰å…¬å¸æœ‰ä¸ªé¡¹ç›®ï¼Œéœ€è¦è·Ÿå·¥è”å¯¹æ¥å¾®ä¿¡æ”¯ä»˜å’Œæ¸…ç®—ï¼Œå¯¹æ¥è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€ä¸ªå¤§å‘ã€‚å› ä¸ºiOSç‰ˆæœ¬çš„å¾®ä¿¡SDKæœ‰æ”¯ä»˜å‚æ•°timestampçš„ç±»å‹ä¸ºUInt32ï¼Œä¹Ÿå°±æ˜¯åªæ”¯æŒåä½ï¼Œè€Œå·¥è”ç»™çš„æ—¶é—´æˆ³æ˜¯åä¸‰ä½çš„ï¼Œè¿™å°±å¯¼è‡´ä¸¤è¾¹ç”Ÿæˆçš„tokenç§˜é’¥ä¸ä¸€è‡´ï¼Œå¯¼è‡´æœ€ç»ˆä¸èƒ½è°ƒèµ·æ”¯ä»˜é¡µé¢ã€‚è€Œæˆ‘ä»¬å°è£…çš„ç»Ÿä¸€æ”¯ä»˜ç»„ä»¶è¾“å‡ºçš„æ”¯ä»˜æ—¥å¿—åœ¨çœŸæœºä¸Šä¹Ÿæ— æ³•æŸ¥çœ‹ï¼Œåªèƒ½çœŸæœºè¿æ¥Macå»è°ƒè¯•ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå½±å“äº†å¯¹æ¥æ•ˆç‡ã€‚è¿˜æœ‰ä¸€äº›è¯¸å¦‚æ­¤ç±»çš„æƒ…æ™¯ï¼Œéœ€è¦æˆ‘ä»¬åœ¨çœŸæœºä¸ŠæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚

æœ¬æ–‡åªæ¢è®¨æ•è·Appleç³»ç»Ÿæ—¥å¿—çš„æ–¹æ¡ˆä¸åŸç†ã€‚æˆ‘å®ç°çš„`ç³»ç»Ÿæ—¥å¿—æŸ¥é˜…å™¨`ä½œä¸ºå­å·¥å…·ç»„ä»¶å·²è¢«é›†æˆåˆ°[iOSçœŸæœºæ¡Œé¢çº§è°ƒè¯•å·¥å…·](https://github.com/summer20140803/TDFScreenDebugger)ä¸­ï¼Œå¯ä»¥ç›´æ¥cloneæˆ–é€šè¿‡Cocoapodsé›†æˆï¼Œæ¬¢è¿StarğŸ¤“

## Apple System Logger
æˆ‘ä»¬å¯ä»¥é€šè¿‡å®˜æ–¹æ–‡æ¡£äº†è§£åˆ°ï¼Œocä¸­æœ€å¸¸è§çš„[NSLog](https://developer.apple.com/documentation/foundation/1395074-nslogv?language=objc)æ“ä½œä¼šåŒæ—¶å°†æ ‡å‡†çš„Errorè¾“å‡ºåˆ°æ§åˆ¶å°å’Œç³»ç»Ÿæ—¥å¿—(syslog)ä¸­(cçš„printfç³»åˆ—å‡½æ•°å¹¶ä¸ä¼šï¼Œswiftçš„printfä¸ºäº†ä¿è¯æ€§èƒ½ä¹Ÿåªä¼šåœ¨æ¨¡æ‹Ÿå™¨ç¯å¢ƒä¸­è¾“å‡º)ã€‚å…¶å†…éƒ¨æ˜¯ä½¿ç”¨Apple System Logger(ç®€ç§°ASL)å»å®ç°çš„ï¼ŒASLæ˜¯è‹¹æœè‡ªå·±å®ç°çš„ç”¨äºè¾“å‡ºæ—¥å¿—åˆ°ç³»ç»Ÿæ—¥å¿—åº“çš„ä¸€å¥—APIæ¥å£ï¼Œæœ‰ç‚¹ç±»ä¼¼äºSQLæ“ä½œã€‚åœ¨iOSçœŸæœºè®¾å¤‡ä¸Šï¼Œä½¿ç”¨ASLè®°å½•çš„logè¢«ç¼“å­˜åœ¨æ²™ç›’æ–‡ä»¶ä¸­ï¼Œç›´åˆ°è®¾å¤‡è¢«é‡å¯ã€‚  

é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•é€šè¿‡ASLå»è·å–åˆ°å­˜æ”¾åœ¨ç³»ç»Ÿæ—¥å¿—ä¸­çš„ç³»ç»Ÿæ—¥å¿—å‘¢ï¼Ÿä¸€å¼€å§‹æˆ‘æƒ³çš„æ˜¯åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œç„¶åå®šæ—¶åœ°é€šè¿‡ASLæ¥å£å»æŸ¥è¯¢æ‰€æœ‰çš„æ—¥å¿—ï¼Œä½†æ˜¯å§‹ç»ˆè§‰å¾—è¿™æ ·å®šæ—¶è·å–æ—¥å¿—çš„é¢‘ç‡å¤ªå¿«çš„è¯ä¼šå½±å“æ€§èƒ½ï¼Œè€Œå¤ªæ…¢çš„è¯åˆä¸èƒ½è¾¾åˆ°å¦‚æœŸçš„æ•ˆæœã€‚æ— å¥ˆåªèƒ½å»æŸ¥é˜…ä¸€äº›èµ„æ–™ï¼Œæœ€ç»ˆåœ¨å¤§åé¼é¼çš„[CocoaLumberjack](https://github.com/CocoaLumberjack/CocoaLumberjack)æºç ä¸­æ‰¾åˆ°äº†æƒ³è¦çš„ç­”æ¡ˆã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡`æ³¨å†Œè¿›ç¨‹ä¹‹é—´çš„ç³»ç»Ÿé€šçŸ¥`æ¥è¾¾åˆ°åŠæ—¶æ•è·ç³»ç»Ÿæ—¥å¿—ï¼Œè¿™ä¸ªæˆ‘ä¼šåœ¨ä¸‹æ–‡ä¸­è¯¦ç»†è¯´æ˜ã€‚æ¥ä¸‹æ¥æˆ‘è®²ä¸€ä¸‹å¤§è‡´çš„å®ç°è¿‡ç¨‹ã€‚

é¦–å…ˆæˆ‘ä»¬å¯¼å…¥asl.hå¤´æ–‡ä»¶ï¼Œ
```objc
#import <asl.h>
```

å¹¶ä¸”åˆ›å»ºä¸€ä¸ªqueryå¯¹è±¡ç”¨äºæ¡ä»¶æŸ¥è¯¢æ—¥å¿—åº“ï¼Œ
```objc
asl_object_t query = asl_new(ASL_TYPE_QUERY);
```

é™¤äº†æˆ‘ä»¬å½“å‰Appè¿›ç¨‹äº§ç”Ÿçš„æ—¥å¿—ï¼Œåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­è‚¯å®šè¿˜å­˜åœ¨åˆ«çš„è¿›ç¨‹ä¸æ–­ç”Ÿæˆçš„æ—¥å¿—ï¼Œä¸è¿‡è¿™ç§è¡Œä¸ºåªå¯èƒ½å‘ç”Ÿåœ¨å¤šè¿›ç¨‹ç¯å¢ƒä¸‹(Xcodeæ¨¡æ‹Ÿå™¨ä¸Š)ï¼Œè€ŒiOSçš„çœŸæœºè®¾å¤‡å¹¶ä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚ä½†ä¸ºäº†å…¼å®¹è¿™ä¸¤ç§ä½¿ç”¨æƒ…æ™¯ï¼Œæˆ‘ä»¬éœ€è¦åƒä¸‹é¢è¿™æ ·é€šè¿‡å½“å‰è¿›ç¨‹çš„idæ¥è¿‡æ»¤æ‰å…¶ä»–è¿›ç¨‹äº§ç”Ÿçš„ç³»ç»Ÿæ—¥å¿—ã€‚
```objc
NSString *pidString = [NSString stringWithFormat:@"%d", [[NSProcessInfo processInfo] processIdentifier]];
asl_set_query(query, ASL_KEY_PID, [pidString UTF8String], ASL_QUERY_OP_EQUAL | ASL_QUERY_OP_NUMERIC);
```
ç„¶åä¸ºäº†æé«˜æŸ¥è¯¢çš„æ€§èƒ½ï¼Œæˆ‘ä»¬å€Ÿé‰´äº†CocoaLumberjackçš„åšæ³•ï¼Œå¸Œæœ›ç³»ç»Ÿåªä»ä¸Šä¸€æ¬¡æŸ¥è¯¢åˆ°çš„æœ€åä¸€æ¡æ—¥å¿—å¼€å§‹å¾€åæŸ¥è¯¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå˜é‡æ¥è®°å½•ä¸Šä¸€æ¬¡æ•è·çš„æœ€åä¸€æ¡æ—¥å¿—çš„idã€‚
```objc
__block unsigned long long lastSeenID  =  0;
```

**é‡ç‚¹æ¥äº†**ã€‚æˆ‘ä»¬éœ€è¦æ³¨å†Œè¿›ç¨‹é€šçŸ¥`kNotifyASLDBUpdate`ï¼Œè¿™æ˜¯è‹¹æœåœ¨æ›´æ–°ASLæ•°æ®åº“å®Œæˆåä¼šå‘å‡ºçš„è·¨è¿›ç¨‹çš„é€šçŸ¥ï¼Œè¿™æ°å¥½ç¬¦åˆæˆ‘ä»¬å®æ—¶æ›´æ–°çš„éœ€æ±‚ã€‚æˆ‘ä»¬éœ€è¦é¢å¤–å¯¼å…¥`<notify.h>`å’Œ`<notify_keys.h>`è¿™ä¸¤ä¸ªå¤´æ–‡ä»¶ã€‚ç„¶åæˆ‘ä»¬å»æ³¨å†Œè¿™ä¸ªé€šçŸ¥ï¼Œå¹¶ä¸”ä¸ºäº†ä¸å½±å“ä¸»çº¿ç¨‹çš„äº‹åŠ¡å’Œä½“éªŒï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å¹¶å‘é˜Ÿåˆ—ä¸­å¼‚æ­¥æ‰§è¡Œè¿™äº›æŸ¥è¯¢äº‹åŠ¡ï¼Œä¸è¿‡ä¸ºäº†æ›´åŠæ—¶åœ°è·å–è¿™äº›æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¼˜å…ˆåº¦è°ƒæ•´ä¸º`DISPATCH_QUEUE_PRIORITY_HIGH`ã€‚
```objc
int notifyToken = 0;
dispatch_queue_t highPriorityGlobalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0);
notify_register_dispatch(kNotifyASLDBUpdate, &notifyToken, highPriorityGlobalQueue, ^(int token) {
    // å›è°ƒä¼šè‡ªåŠ¨ä¼ å…¥æ³¨å†Œæ—¶ä¼ é€’çš„é€šçŸ¥tokenï¼Œæˆ‘ä»¬å°†å…¶ä¿å­˜ä¸‹æ¥ï¼Œæ–¹ä¾¿æˆ‘ä»¬éšæ—¶æ³¨é”€è¿™ä¸ªé€šçŸ¥
    self.notifyToken = token;
   
    // ä¸‹é¢æ‰§è¡Œä¸€ç³»åˆ—queryäº‹åŠ¡...
}
```

ç„¶åæˆ‘ä»¬ç»§ç»­ç»™queryå¢åŠ ç­›é€‰æ¡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥è¯¢çš„æ˜¯`asl message id`å¤§äºä¹‹å‰è®°å½•çš„`lastSeenID`çš„é‚£äº›æ—¥å¿—ä¿¡æ¯ã€‚
```objc
char queryContext[64];
snprintf(queryContext, sizeof queryContext, "%llu", lastSeenID);
asl_set_query(query, ASL_KEY_MSG_ID, queryContext, ASL_QUERY_OP_GREATER | ASL_QUERY_OP_NUMERIC);
```

queryçš„ç­›é€‰æ¡ä»¶å·²ç»æ·»åŠ å®Œäº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`asl_search`å‡½æ•°æŸ¥è¯¢æ—¥å¿—æ•°æ®åº“äº†ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒæŸ¥è¯¢åˆ°çš„ç»“æœ â€” `aslresponse`å¹¶ä¸ç›´æ¥æºå¸¦æ—¥å¿—ä¿¡æ¯ï¼Œéœ€è¦å†é€šè¿‡`asl_next`å‡½æ•°å°†å…¶éå†è·å–æ—¥å¿—ä¿¡æ¯ï¼Œç›´åˆ°`asl_next`å‡½æ•°å–å‡ºçš„ä¿¡æ¯ä¸º`NULL`ä¸ºæ­¢ã€‚
```objc
aslresponse response = asl_search(NULL, query);
aslmsg aslMessage = NULL;
                    
NSMutableArray *newLogs = [NSMutableArray array];
                    
while ((aslMessage = asl_next(response))) {                        
    const char *timeInterval = asl_get(aslMessage, ASL_KEY_TIME);
    const char *messageId = asl_get(aslMessage, ASL_KEY_MSG_ID);
    const char *message = asl_get(aslMessage, ASL_KEY_MSG);

    TDFSDLVLogModel *log = [[TDFSDLVLogModel alloc] init];
    // è¿™é‡Œå¯ä»¥ç»™è‡ªå®šä¹‰æ¨¡å‹èµ‹å€¼...
    [newLogs addObject:log];

    if (messageId) {
        lastSeenID = atoll(asl_get(aslMessage, ASL_KEY_MSG_ID));
    }
}
```
å…¶ä¸­
```objc
lastSeenID = atoll(asl_get(aslMessage, ASL_KEY_MSG_ID));
```
æ˜¯ä¸ºäº†è®°å½•ä¸‹æŸ¥è¯¢åˆ°çš„æœ€åä¸€æ¡æ—¥å¿—ä¿¡æ¯çš„IDã€‚  

æœ€åè®°å¾—åœ¨è·å–å®Œç¬¦åˆæ¡ä»¶çš„æ—¥å¿—ä¹‹åï¼Œé€šè¿‡ASLè‡ªå¸¦çš„å†…å­˜é‡Šæ”¾å‡½æ•°é‡Šæ”¾`response`å’Œ`query`å˜é‡ã€‚
```objc
asl_release(response);
asl_free(query);
```

## ASLåœ¨iOS10åè¢«å¼ƒç”¨
å¾ˆä¸å¹¸çš„æ˜¯ï¼Œè‹¹æœçˆ¸çˆ¸å› ä¸ºæƒ³å‡å¼±ASLå¯¹äºæ—¥å¿—æ–¹é¢çš„ä¾µå…¥æ€§ï¼Œåœ¨iOS10ä¹‹åï¼Œå°†ç”±os_logç›¸å…³çš„APIå…¨é¢æ›¿ä»£ASLã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡[Logging API](https://developer.apple.com/documentation/os/logging?language=objc)æˆ–è€…[è¿™é‡Œ](https://stackoverflow.com/questions/40272910/read-logs-using-the-new-swift-os-log-api)å¾—çŸ¥è¿™ä¸€æ¶ˆæ¯ã€‚å› è€Œæˆ‘ä»¬ä¸å¾—ä¸åœ¨iOS10ä¹‹åå¯»æ‰¾ä¸€ç§ç‰ˆæœ¬å…¼å®¹çš„è§£å†³æ–¹æ¡ˆã€‚

## pipeã€dup2ä¸GCDçš„å®Œç¾åä½œ
é¦–å…ˆæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹è¾“å‡ºé‡å®šå‘çš„æ¦‚å¿µã€‚  
NSLogèƒ½è¾“å‡ºåˆ°æ–‡ä»¶syslogä¸­ï¼Œé çš„æ˜¯æ–‡ä»¶IOçš„APIçš„è°ƒç”¨ï¼Œé‚£ä¹ˆåœ¨è¿™äº›IOæ“ä½œä¸­ï¼Œä¸€å®šå­˜åœ¨æ–‡ä»¶å¥æŸ„ã€‚  
åœ¨Cè¯­è¨€ä¸­ï¼Œå­˜åœ¨é»˜è®¤çš„ä¸‰ä¸ªæ–‡ä»¶å¥æŸ„ã€‚  
```c
#define stdin __stdinp

#define stdout __stdoutp

#define stderr __stderrp
```
å…¶å¯¹åº”çš„ä¸‰ä¸ªiOSç‰ˆæœ¬çš„æ–‡ä»¶å¥æŸ„æ˜¯
```objc
  #define STDIN_FILENO 0 /* standard input file descriptor */

  #define STDOUT_FILENO 1 /* standard output file descriptor */

  #define STDERR_FILENO 2 /* standard error file descriptor */
```
`NSLog`æ–¹æ³•é»˜è®¤æ“çºµçš„æ˜¯`STDERR_FILENO`å¥æŸ„ã€‚  

æˆ‘ä»¬å¯ä»¥é€šè¿‡Cå‡½æ•°
```c
FILE * freopen(const char * filename, const char * mode, FILE * stream);
```
è¿›è¡Œé‡å®šå‘ï¼Œå…¶ä¸­filenameä¸ºå­˜æ”¾æ—¥å¿—çš„è·¯å¾„ï¼Œmodeä¸ºè¯»å†™æ¨¡å¼ï¼Œstreamä¸ºæ–‡ä»¶å¥æŸ„ã€‚  

æœ‰ä¸€ä¸ªé—®é¢˜è·Ÿéšè€Œæ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å°†é‡å®šå‘è¿˜åŸå‘¢ï¼ŸUnixçš„`dup`å’Œ`dup2`å‡½æ•°æ°é€¢å…¶æ—¶ã€‚
```c
int dup(int oldfd);
int dup2(int oldfd, int newfd);
```

`dup`å‡½æ•°å¯ä»¥ä¸ºæˆ‘ä»¬å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¼ ç»™è¯¥å‡½æ•°ä¸€ä¸ªæ—¢æœ‰çš„æè¿°ç¬¦ï¼Œå®ƒå°±ä¼šè¿”å›ä¸€ä¸ªæ–°çš„æè¿°ç¬¦ï¼Œè¿™ä¸ªæ–°çš„æè¿°ç¬¦æ˜¯ä¼ ç»™å®ƒçš„æè¿°ç¬¦çš„æ‹·è´ã€‚è¿™æ„å‘³ç€ï¼Œè¿™ä¸¤ä¸ªæè¿°ç¬¦å…±äº«åŒä¸€ä¸ªæ•°æ®ç»“æ„ã€‚  
è€Œ`dup2`å‡½æ•°è·Ÿdupå‡½æ•°ç›¸ä¼¼ï¼Œä½†dup2å‡½æ•°å…è®¸è°ƒç”¨è€…è§„å®šä¸€ä¸ªæœ‰æ•ˆæè¿°ç¬¦å’Œç›®æ ‡æè¿°ç¬¦çš„idã€‚dup2å‡½æ•°æˆåŠŸè¿”å›æ—¶ï¼Œç›®æ ‡æè¿°ç¬¦ï¼ˆdup2å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰å°†å˜æˆæºæè¿°ç¬¦ï¼ˆdup2å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰çš„å¤åˆ¶å“ï¼Œæ¢å¥è¯è¯´ï¼Œä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ç°åœ¨éƒ½æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”æ˜¯å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘çš„æ–‡ä»¶ã€‚  
é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨`dup`å’Œ`dup2`å¸®æˆ‘ä»¬å®ç°é‡å®šå‘çš„è¿˜åŸã€‚
```objc
int originLogPath = dup(STDERR_FILENO);
dup2(originLogPath, STDERR_FILENO);
```

ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œä½¿ç”¨`freopen`å‡½æ•°å¹¶ä¸èƒ½è§£å†³æˆ‘ä»¬å¦‚ä½•é«˜æ•ˆå®æ—¶è·å–æ—¥å¿—çš„é—®é¢˜ã€‚å› ä¸ºä¸€æ—¦é€šè¿‡`freopen`å°†stderrè¾“å‡ºé‡å®šå‘åˆ°æŸä¸€æŒ‡å®šçš„æ–‡ä»¶åï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åœ¨è¯»å–æ–‡ä»¶çš„åŒæ—¶æ£€æµ‹å˜åŒ–ï¼Œè¿™å°†è®©æˆ‘ä»¬çš„å®ç°å˜å¾—å¤æ‚ï¼Œä¸”ä¸€ç›´å¯¹æ–‡ä»¶è¿›è¡ŒIOæ“ä½œä¹Ÿæè€—æ€§èƒ½ã€‚æ— å¥ˆä¹‹ä¸‹åªèƒ½æ”¾å¼ƒ`freopen`å‡½æ•°ã€‚  

æœ€ååœ¨[è¿™é‡Œ](http://lizaochengwen.iteye.com/blog/1476080)æ‰¾åˆ°äº†ç­”æ¡ˆï¼Œpipeå°±æ˜¯æˆ‘ä»¬çš„ç­”æ¡ˆã€‚pipeæ˜¯Linuxç®¡é“ç¼–ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªå‡½æ•°ï¼Œå…·ä½“å‚è§[è¿™é‡Œ](http://blog.51cto.com/huyoung/436494)ã€‚å› ä¸ºpipeæ‰€å®ç°çš„æ˜¯å­˜åœ¨äºå†…å­˜å½“ä¸­çš„è¯»å†™æœºåˆ¶ï¼Œæ‰€ä»¥æ— è®ºä»å®ç°è¿˜æ˜¯æ€§èƒ½éƒ½ä¼˜äº`freopen`çš„æ–¹æ¡ˆã€‚
```objc
int fd = STDERR_FILENO;
int origianlFD = fd;
int originalStdHandle = dup(fd);

int fildes[2];
pipe(fildes);  
dup2(fildes[1], fd);
close(fildes[1]);
fd = fildes[0]; 
```
ä¸€å¼€å§‹é€šè¿‡dupå‡½æ•°ä¿å­˜äº†STDERR_FILENOçš„è¾“å‡ºæ–‡ä»¶æè¿°ï¼Œç„¶åå°†åˆ›å»ºçš„fildesä¼ å…¥pipeå‡½æ•°ï¼Œfildes[0]å°±æ˜¯è¯»æœ«ç«¯ï¼Œè€Œfildes[1]å°±æˆäº†å†™æœ«ç«¯ã€‚ç„¶åè°ƒç”¨dup2å‡½æ•°å°†STDERR_FILENOçš„è¾“å‡ºé‡å®šå‘åˆ°pipeç®¡é“æµçš„å†™å…¥ç«¯ï¼Œå³è¾¾åˆ°äº†å°†ç³»ç»Ÿæ—¥å¿—é‡å®šå‘åˆ°pipeçš„æ“ä½œã€‚æ¥ç€å°†fdæŒ‡å‘fildes[0]å³pipeçš„è¯»æœ«ç«¯ï¼Œç„¶åé…åˆGCDçš„sourceç›‘å¬å°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„æ•ˆæœäº†ï¼Œç›´æ¥çœ‹å®Œæ•´ä»£ç ã€‚
```objc
if (self.source_t) {
    dispatch_cancel(self.source_t);
}

int fd = STDERR_FILENO;
int origianlFD = fd;
int originalStdHandle = dup(fd); // save the original for reset

int fildes[2];
pipe(fildes);  // [0] is read end of pipe while [1] is write end
dup2(fildes[1], fd);  // duplicate write end of pipe "onto" fd (this closes fd)
close(fildes[1]);  // close original write end of pipe
fd = fildes[0];  // we can now monitor the read end of the pipe

NSMutableData* receivedData = [[NSMutableData alloc] init];
fcntl(fd, F_SETFL, O_NONBLOCK);// set the reading of this file descriptor without delay

dispatch_queue_t highPriorityGlobalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0);
dispatch_source_t source_t = dispatch_source_create(DISPATCH_SOURCE_TYPE_READ, fd, 0, highPriorityGlobalQueue);

int writeEnd = fildes[1];
dispatch_source_set_cancel_handler(source_t, ^{
    close(writeEnd);
    // reset the original file descriptor
    dup2(originalStdHandle, origianlFD);
});

dispatch_source_set_event_handler(source_t, ^{
    @autoreleasepool {
        char buffer[[[TDFSDPersistenceSetting sharedInstance] limitSizeOfSingleSystemLogMessageData]];
        ssize_t size = read(fd, (void*)buffer, (size_t)(sizeof(buffer)));
        
        [receivedData setLength:0];
        [receivedData appendBytes:buffer length:size];
    
        NSString *logMessage = [[NSString alloc] initWithData:receivedData encoding:NSUTF8StringEncoding];
        if (logMessage) {
            TDFSDLVLogModel *log = [[TDFSDLVLogModel alloc] init];
            log.id = @"NO MSG ID";
            log.message = logMessage;
            log.time = [self.dateFormatter stringFromDate:[NSDate dateWithTimeIntervalSinceNow:0]];
            
            // logs prop is observed outside, for safety, we should update logs prop context in main thread
            dispatch_async(dispatch_get_main_queue(), ^{
                NSMutableArray *currentLogs = [self.logs mutableCopy];
                [currentLogs addObject:log];
                self.logs = currentLogs;
            });
            
            printf("\n%s\n",[logMessage UTF8String]);
        }
    }
});

dispatch_resume(source_t);

self.source_t = source_t;
```

å…¶ä¸­
```objc
fcntl(fd, F_SETFL, O_NONBLOCK);
```
ç”¨äºä¿®æ”¹fdæ‰€å¯¹åº”çš„è¯»æœ«ç«¯çš„æ–‡ä»¶çŠ¶æ€ä¸ºæ²¡æœ‰å»¶è¿Ÿï¼›

```objc
dispatch_source_set_cancel_handler(source_t, ^{
    // ...
});
```
ç”¨äºè®¾ç½®å–æ¶ˆsourceç›‘å¬çš„å›è°ƒäº‹ä»¶ï¼›

```objc
dispatch_source_set_event_handler(source_t, ^{
    // ...
});
```
ç”¨äºè®¾ç½®fdæœ‰æ–°å†…å®¹çš„å›è°ƒï¼›

```objc
printf("\n%s\n",[logMessage UTF8String]);
```
æ˜¯ä¸ºäº†è®©æ—¥å¿—ä¿¡æ¯é¢å¤–è¾“å‡ºåˆ°STDOUT_FILENOï¼Œä¿è¯æ—¥å¿—ä¾ç„¶èƒ½åœ¨Xcodeçš„æ§åˆ¶å°ä¸­è¾“å‡ºï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚

## æœ€ç»ˆæ•ˆæœ


## å‚è€ƒ
* [Loggingå®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/os/logging?language=objc)
* [NSLogå®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/foundation/1395074-nslogv?language=objc)
* [CocoaLumberjack](https://github.com/CocoaLumberjack/CocoaLumberjack)
* [Cè¯­è¨€ä¸­çš„pipeå‡½æ•°](http://blog.51cto.com/huyoung/436494)
* [Linux dup/dup2](http://man7.org/linux/man-pages/man2/dup.2.html)
* [https://stackoverflow.com/questions/40272910/read-logs-using-the-new-swift-os-log-api](https://stackoverflow.com/questions/40272910/read-logs-using-the-new-swift-os-log-api)
* [http://lizaochengwen.iteye.com/blog/1476080](http://lizaochengwen.iteye.com/blog/1476080)
