---
layout:     post
title:      iOSä½¿ç”¨ä»£ç æ’æŸ¥é‡æŒ‡é’ˆé”™è¯¯
date:       2017-12-25
author:     å¼€ä¸äº†å£çš„çŒ«
header-img: img/icon_wild_pointer_error_bg.jpg
catalog: true
tags:
    - iOS
    - é‡æŒ‡é’ˆ
---

## å‰è¨€
å¦‚æœä¸€ä¸ªæŒ‡é’ˆå…ˆå‰æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œä½†è¿™ä¸ªå¯¹è±¡éšåè¢«é‡Šæ”¾äº†ï¼Œå¦‚æœè¯¥æŒ‡é’ˆæ²¡æœ‰åšä»»ä½•çš„ä¿®æ”¹ï¼Œå¯¼è‡´ä»ç„¶æŒ‡å‘ç€é‚£å—å†…å­˜åœ°å€ï¼Œåˆ™è¯¥æŒ‡é’ˆå·²æˆä¸ºäº†`é‡æŒ‡é’ˆ`ã€‚

å¯¹äºéARCé¡¹ç›®è€Œè¨€ï¼Œé‡æŒ‡é’ˆé—®é¢˜ç®€ç›´è¢«è§†ä¸ºcrashä¸­çš„å¸¸å®¢ã€‚è€Œå¯¹äºå¦‚ä»Šå‡ ä¹æ‰€æœ‰ç±»éƒ½æ˜¯ARCæ¥è‡ªåŠ¨ç®¡ç†å†…å­˜çš„é¡¹ç›®æ¥è¯´ï¼Œé‡æŒ‡é’ˆé—®é¢˜å°±æ²¡é‚£ä¹ˆå¸¸è§äº†ï¼Œä¸è¿‡å¸¸è§æ˜¯ä¸å¸¸è§ï¼Œä¸€æ—¦è§ç€ï¼Œå¤Ÿä½ å–ä¸€å£¶äº†ï¼Œä¸ªä¸ªéƒ½å¯èƒ½æ˜¯ç–‘éš¾æ‚ç—‡ã€‚é‡æŒ‡é’ˆå¯¼è‡´çš„å´©æºƒå¾€å¾€éš¶å±äº[å‰æ–‡](https://summer20140803/2017/11/23/iOSçš„å´©æºƒæ•è·æ–¹æ¡ˆ/)è®²åˆ°çš„`mach exception`æˆ–è€…`signal`é”™è¯¯ã€‚ä½†æ˜¯ä½ å¾ˆéš¾åœ¨å †æ ˆä¿¡æ¯ä¸­æ‰¾åˆ°æœ‰ç”¨çš„çº¿ç´¢æ¥è¿½æº¯åˆ°é‡æŒ‡é’ˆçš„æºå¤´ã€‚è€Œä¸”é‡æŒ‡é’ˆå¯¼è‡´çš„é”™è¯¯åƒå¥‡ç™¾æ€ªï¼Œè¿™é‡Œå¼•ç”¨è…¾è®¯Buglyçš„ä¸€å¼ æè¿°é‡æŒ‡é’ˆçš„å›¾ï¼š
![ctdpic](https://ws4.sinaimg.cn/large/006tKfTcgy1fshp9k4pz2j30pi0ht78g.jpg)

ä¸è¿‡å¥½åœ¨Xcodeä¸ºæˆ‘ä»¬å†…ç½®äº†ä¸€äº›ç”¨äºæ£€æµ‹é‡æŒ‡é’ˆé”™è¯¯çš„æ’ä»¶ã€‚
![ctdpic](https://ws4.sinaimg.cn/large/006tKfTcgy1fshpeekszej31ds0s079t.jpg)
Xcodeæä¾›äº†`Malloc Scribble`å¯¹å·²é‡Šæ”¾å†…å­˜è¿›è¡Œæ•°æ®å¡«å……ï¼Œä»è€Œä¿è¯é‡æŒ‡é’ˆè®¿é—®æ˜¯å¿…ç„¶å´©æºƒçš„ï¼Œè¿™æ˜¯ä¸€ç§å¢åŠ é‡æŒ‡é’ˆçš„å¿…ç°æ¦‚ç‡ä»è€Œæé«˜é‡æŒ‡é’ˆæ›å…‰ç‡çš„æœºåˆ¶ã€‚  
åŒæ—¶ä¹Ÿæä¾›äº†`Zombie Objects`è¿™ä¸€ç§å®Œå…¨ä¸åŒçš„é‡æŒ‡é’ˆè°ƒè¯•æœºåˆ¶ï¼Œå°†é‡Šæ”¾çš„å¯¹è±¡æ ‡è®°ä¸ºZombieå¯¹è±¡ï¼Œå†æ¬¡ç»™Zombieå¯¹è±¡å‘é€æ¶ˆæ¯æ—¶ï¼Œå‘ç”Ÿcrashå¹¶ä¸”è¾“å‡ºç›¸å…³çš„è°ƒç”¨ä¿¡æ¯ã€‚è¿™å¥—æœºåˆ¶åŒæ—¶å®šä½äº†å‘ç”Ÿcrashçš„ç±»å¯¹è±¡ä»¥åŠæœ‰ç›¸å¯¹æ¸…æ™°çš„è°ƒç”¨æ ˆã€‚  
æˆ‘ä»¬å¯ä»¥å¾ˆå¥½çš„åœ¨è¿™ä¸¤ç§æ’æŸ¥æœºåˆ¶ä¸‹æ‰¾åˆ°é‡æŒ‡é’ˆçš„ä¸€äº›è››ä¸é©¬è¿¹ã€‚  

ç„¶è€Œï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½æ€»ä¾èµ–äºè¿æ¥Xcodeè¿›è¡Œè°ƒè¯•ï¼Œå¦‚æœé‡æŒ‡é’ˆé—®é¢˜å‘ç”Ÿåœ¨çœŸæœºï¼Œè€Œä¸ºäº†èƒ½åœ¨ç°åœºå¤ç›˜å¹¶æ’æŸ¥é‡æŒ‡é’ˆé—®é¢˜çš„æ ¹æºï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥ç›´æ¥é€šè¿‡ä»£ç æ¥å®ç°è¿™äº›æœºåˆ¶å‘¢ï¼Ÿ  

è…¾è®¯Buglyå€Ÿé‰´`Malloc Scribble`æœºåˆ¶åŸç†ï¼Œé€šè¿‡ä¿®æ”¹freeå‡½æ•°ï¼Œå¯¹å·²é‡Šæ”¾å¯¹è±¡è¿›è¡Œéæ³•æ•°æ®å¡«å……æ¥æé«˜é‡æŒ‡é’ˆçš„å´©æºƒç‡ã€‚
è€Œæˆ‘ä»¬åˆ™å¯ä»¥é€‰æ‹©å€Ÿé‰´`Zombie Objects`æœºåˆ¶ç”¨ä»£ç æ¥å®ç°ä¸€å¥—é‡æŒ‡é’ˆè°ƒå‰‚æœºåˆ¶ã€‚è¿™ç§æœºåˆ¶çš„å®ç°æ›´ä¸ºç®€å•ï¼Œæ— é¡»å»hookåº•å±‚çš„`free`å‡½æ•°ã€‚

å¦å¤–ï¼Œæˆ‘å®ç°çš„`è‡ªåŠ¨åŒ–é‡æŒ‡é’ˆæ’æŸ¥å·¥å…·`ä½œä¸ºå­å·¥å…·ç»„ä»¶å·²è¢«é›†æˆåˆ°[iOSçœŸæœºæ¡Œé¢çº§è°ƒè¯•å·¥å…·](https://github.com/summer20140803/TDFScreenDebugger)ä¸­ï¼Œå¯ä»¥ç›´æ¥cloneæˆ–é€šè¿‡Cocoapodsé›†æˆï¼Œæ¬¢è¿StarğŸ¤“

## å®ç°æ€è·¯
ä¸ºäº†æ•ˆä»¿Xcode`Zombie Objects`è¿™ä¸€æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨[dealloc](https://developer.apple.com/documentation/objectivec/nsobject/1571947-dealloc)æ–¹æ³•ä¼šè‡ªåŠ¨å®ç°`çˆ¶ç±»çš„deallocæ–¹æ³•`çš„ç‰¹æ€§ï¼Œhookä½`NSObject`å’Œ`NSProxy`ä¸¤ä¸ªocçš„æ ¹ç±»çš„deallocæ–¹æ³•ï¼Œç„¶ååœ¨è°ƒå‰‚æ–¹æ³•ä¸­å°†æœ¬æ¥å³å°†é‡Šæ”¾çš„å¯¹è±¡çš„isaæŒ‡é’ˆæ”¹ä¸ºæŒ‡å‘æˆ‘ä»¬åˆ›å»ºçš„ä¸€ä¸ªæ–°çš„åƒµå°¸ç±»ï¼Œç„¶åå¤–ç•Œå¯¹è¿™ä¸ªåƒµå°¸ç±»å‘é€ä»»ä½•æ¶ˆæ¯(objc_msgSend)éƒ½ä¼šå‘ç¨‹åºå‘é€æˆ‘ä»¬æ‰‹åŠ¨æŠ›å‡ºçš„`åº”ç”¨çº§å¼‚å¸¸-NSException`ï¼Œç„¶ååœ¨æŠ›å‡ºçš„å¼‚å¸¸çš„`reason`ä¸­æˆ‘ä»¬å°†éæ³•è°ƒç”¨å¯¹è±¡çš„å®é™…ç±»å‹å’Œè°ƒç”¨æ–¹æ³•è¾“å‡ºï¼Œå¸®åŠ©ä½¿ç”¨è€…æ›´å¥½åœ°å®šä½é‡æŒ‡é’ˆé”™è¯¯çš„æ ¹æºã€‚  

## å…·ä½“å®ç°
é¦–å…ˆåƒä¸‹é¢è¿™æ ·ç›´æ¥hook`NSObject`å’Œ`NSProxy`ä¸¤ä¸ªæ ¹ç±»çš„`dealloc`æ–¹æ³•ï¼Œå¹¶å°†åŸå§‹çš„deallocçš„IMPå®ç°ä¿å­˜ä¸‹æ¥ï¼Œä¾¿äºåé¢é‡Šæ”¾è¿™äº›å¯èƒ½é€ æˆæ³„æ¼çš„å¯¹è±¡ã€‚
```objc
SEL deallocSelector = @selector(dealloc);
self.rootSwizzledClasses = @[[NSObject class], [NSProxy class]];

for (Class rootClass in self.rootSwizzledClasses) {

    if (!class_addMethod(rootClass, deallocSelector, newDeallocIMP, "v@:")) {
        void (*originalDeallocIMP)(__unsafe_unretained id, SEL) = NULL;
    
        Method deallocMethod = class_getInstanceMethod(rootClass, deallocSelector);
        originalDeallocIMP = (__typeof__(originalDeallocIMP))method_getImplementation(deallocMethod);
        originalDeallocIMP = (__typeof__(originalDeallocIMP))method_setImplementation(deallocMethod, newDeallocIMP);
        
        [deallocImpMaps setObject:[NSValue valueWithBytes:&originalDeallocIMP objCType:@encode(typeof(originalDeallocIMP))] forKey:NSStringFromClass(rootClass)];
    }
}
```
ç„¶åRunä¸€ä¸‹å‘ç°ï¼ŒXcodeç›´æ¥ç¼–è¯‘æŠ¥é”™äº†ï¼Œæç¤ºæˆ‘ä»¬ARCç¯å¢ƒä¸‹ä¸èƒ½ä¿®æ”¹`dealloc`æ–¹æ³•ã€‚ç„¶åå‚è€ƒäº†å¤§åé¼é¼çš„[ReactiveObjC](https://github.com/ReactiveCocoa/ReactiveObjC)ä¸­çš„`NSObject+RACDeallocating.m`å¯¹äºdeallocçš„è°ƒå‰‚ç»†èŠ‚ï¼Œæœæ–­æ”¹æˆ`sel_registerName`è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚
```objc
SEL deallocSelector = sel_registerName("dealloc");
```
ç„¶ååæœŸè°ƒè¯•å‘ç°ï¼Œç›´æ¥ä½¿ç”¨`NSSelectorFromString`å°±å®Œäº‹å„¿äº†ğŸ˜…ã€‚  

ç„¶åæˆ‘ä»¬é‡æ–°å®ç°deallocçš„æ–¹æ³•å®ç°ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªæ–¹æ¡ˆæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚
```objc
self.newDeallocBlock = ^void(__unsafe_unretained id target) {
            
    __weak typeof(weak_self) strong_self = weak_self;
    
    @synchronized(strong_self) {
        Class currentClass = [target class];
        
        object_setClass(target, [TDFSDWPCZombieProxy class]);
        ((TDFSDWPCZombieProxy *)target).originClass = currentClass;
    }
};
```
æˆ‘ä»¬å°†æœ¬è¦é‡Šæ”¾çš„å¯¹è±¡çš„`isaæŒ‡é’ˆ`é‡æ–°æŒ‡å‘äº†æˆ‘ä»¬æ–°åˆ›å»ºçš„åƒµå°¸ç±»`TDFSDWPCZombieProxy`ã€‚ç„¶åå†é€šè¿‡è¿™ä¸ªåƒµå°¸ç±»çš„`originClass`å±æ€§å»ä¿å­˜ä¸‹åŸå§‹å¯¹è±¡çš„`class`ã€‚  

ç´§æ¥ç€æˆ‘ä»¬çœ‹ä¸€ä¸‹`TDFSDWPCZombieProxy`è¿™ä¸ªç±»çš„å®ç°ã€‚
```objc
#import "TDFSDWPCZombieProxy.h"

@implementation TDFSDWPCZombieProxy

#define __ZombieBlew  [self zombieProxyBlew:_cmd]
#define __ZombieBlewWithSelector(selector)  [self zombieProxyBlew:selector]

#pragma mark - override
- (void)forwardInvocation:(NSInvocation *)invocation { __ZombieBlewWithSelector(invocation.selector); }
- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { __ZombieBlewWithSelector(sel); return nil; }

- (BOOL)isEqual:(id)object { __ZombieBlew; return NO; }
- (Class)class { __ZombieBlew; return nil; }
- (instancetype)self { __ZombieBlew; return nil; }
- (id)performSelector:(SEL)aSelector { __ZombieBlew; return nil; }
- (id)performSelector:(SEL)aSelector withObject:(id)object { __ZombieBlew; return nil; }
- (id)performSelector:(SEL)aSelector withObject:(id)object1 withObject:(id)object2 { __ZombieBlew; return nil; }
- (BOOL)isProxy { __ZombieBlew; return NO; }
- (BOOL)isKindOfClass:(Class)aClass { __ZombieBlew; return NO; }
- (BOOL)isMemberOfClass:(Class)aClass { __ZombieBlew; return NO; }
- (BOOL)conformsToProtocol:(Protocol *)aProtocol { __ZombieBlew; return NO; }
- (BOOL)respondsToSelector:(SEL)aSelector { __ZombieBlew; return NO; }
- (instancetype)retain { __ZombieBlew; return nil; }
- (oneway void)release { __ZombieBlew; }
- (instancetype)autorelease { __ZombieBlew; return nil; }
- (NSUInteger)retainCount { __ZombieBlew; return NSNotFound; }
- (struct _NSZone *)zone { __ZombieBlew; return NULL; };
- (void)dealloc { __ZombieBlew; [super dealloc]; }
- (NSString *)description { __ZombieBlew; return nil; }
- (NSString *)debugDescription { __ZombieBlew; return nil; }
- (NSUInteger)hash { __ZombieBlew; return NSNotFound; }
- (Class)superclass { __ZombieBlew; return nil; }

#pragma mark - private
- (void)zombieProxyBlew:(SEL)selector {
    @throw [NSException exceptionWithName:NSInternalInconsistencyException reason: \
            [NSString stringWithFormat:@"[TDFScreenDebugger.PerformanceMonitor.WildPointerChecker] find a wild pointer error about \' message \" [%@ %@] \" was sent to a zombie object at address: %p \'", NSStringFromClass(self.originClass), NSStringFromSelector(selector), self] userInfo:nil];
}

@end
```
å› ä¸ºè€ƒè™‘åˆ°è¿™ä¸ªåƒµå°¸ç±»éœ€è¦åœ¨æ¥æ”¶åˆ°ä»»ä½•æ¶ˆæ¯çš„æ—¶å€™æŠ›å‡ºæˆ‘ä»¬é¢„è®¾çš„`NSException`å¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªç±»çš„`Automatic Reference Counting`è®¾ç½®æˆNOï¼Œå³MRCæ¨¡å¼ã€‚
![](https://ws3.sinaimg.cn/large/006tKfTcgy1fshxt711ttj311c04yabk.jpg)
ç„¶åè¦†å†™æ‰€æœ‰çš„æ–¹æ³•åŒ…æ‹¬æ¶ˆæ¯è½¬å‘çš„å…³é”®æ–¹æ³•ä¸­æŠ›å‡ºæˆ‘ä»¬é¢„è®¾çš„å¼‚å¸¸ï¼Œå°†é‡æŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„`ç±»å`å’Œ`å†…å­˜åœ°å€`ä»¥åŠ`è°ƒç”¨æ–¹æ³•`è¾“å‡ºç»™å¼€å‘è€…ä»¥ä¾›è¿›ä¸€æ­¥è°ƒè¯•ã€‚

æœ€åæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯¹è±¡ç¼“å­˜æ± æœºåˆ¶ï¼Œåœ¨å†…å­˜è¿‡é«˜æ”¶åˆ°`ç³»ç»Ÿé€šçŸ¥`æˆ–è¾¾åˆ°é¢„è®¾çš„`é˜ˆå€¼`æ—¶å°†è‡ªåŠ¨å°†é‚£äº›åƒµå°¸ç±»å¯¹è±¡isaæŒ‡é’ˆè¿˜åŸæˆåŸæ¥çš„ç±»å¹¶è°ƒç”¨æ ¹ç±»åŸæœ¬çš„deallocæ–¹æ³•å®ç°æ¥æ­£ç¡®åœ°é‡Šæ”¾èµ„æºã€‚
```objc
- (void)clearCachePool {
    // 1.å–å‡ºæ‰€æœ‰ç¼“å­˜çš„target...
    self.cacheTargets = @[...];

    // 2.éå†targetï¼Œè¿˜åŸisaæŒ‡å‘å¹¶é‡Šæ”¾èµ„æº
    for (id target in self.cacheTargets) {
        [self invokeOriginDealloc:target];
    }
}

- (void)invokeOriginDealloc:(__unsafe_unretained id)target {
    Class currentCls = [target class];
    Class rootCls = currentCls;
    SEL deallocSelector = sel_registerName("dealloc");
    
    rootCls = ([rootCls isSubclassOfClass:[NSProxy class]] ? [NSProxy class] : [NSObject class]);
    
    NSString *clsName = NSStringFromClass(rootCls);
    void (*originalDeallocIMP)(__unsafe_unretained id, SEL) = NULL;
    [[self.rootClassesOriginImps objectForKey:clsName] getValue:&originalDeallocIMP];
    
    if (originalDeallocIMP != NULL) {
        originalDeallocIMP(target, deallocSelector);
        target = nil;
    }
}
```

å› ä¸ºåšä¸»å·²åœ¨[å‰æ–‡](https://summer20140803/2017/11/23/iOSçš„å´©æºƒæ•è·æ–¹æ¡ˆ/)å®ç°äº†`è‡ªåŠ¨åŒ–å´©æºƒæ•è·ç»„ä»¶å·¥å…·`ï¼Œè€Œè¿™è¾¹çš„å¤„ç†æ°å·§æ˜¯é€šè¿‡`NSException`å¼•å‘å¼‚å¸¸ä½¿ç¨‹åºå´©æºƒï¼Œä¸å‡ºæ„æ–™åœ°ä¼šè¢«å´©æºƒæ•è·å·¥å…·æ•è·ã€‚æ‰€ä»¥å¦‚æœä½ ä½¿ç”¨çš„æ˜¯åšä¸»çš„è¿™ä¸€æ•´å¥—ç»„ä»¶çš„è¯ï¼Œé‚£ä¹ˆåœ¨çœŸæœºè°ƒè¯•é‡åˆ°é‡æŒ‡é’ˆé”™è¯¯æ—¶è°ƒè¯•æ•ˆæœä¼šæ›´ä½³å“Ÿ~

## ä¸€äº›ç–‘é—®
åœ¨åæ¥çš„è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¸€ä¸ªå¾ˆç¥å¥‡çš„ç°è±¡ï¼Œå½“æˆ‘ä»¬å»ºç«‹äº†ç¼“å­˜æ± ï¼Œå¹¶å°å¿ƒç¿¼ç¿¼åœ°é€šè¿‡`NSValue`å°†æ¯ä¸€ä¸ªtargetçš„`å¼±å¼•ç”¨`åŒ…è£…èµ·æ¥ï¼Œåœ¨å†…å­˜å³°å€¼è¾¾åˆ°é˜ˆå€¼æ—¶ç»Ÿä¸€æ¸…ç†ï¼Œä½†Xcodeçš„å†…å­˜æ˜¾ç¤ºæ•°å€¼å¹¶æ²¡æœ‰ä¸‹é™ï¼Œåè€Œä¸Šæ¶¨çš„æ›´ä¸¥é‡äº†ï¼Œç„¶åå¤šæ¬¡è¯•éªŒå‡ä»¥å¤±è´¥å‘Šç»ˆï¼Œç›®å‰æ„Ÿè§‰ä»£ç å¹¶æ²¡æœ‰ä»€ä¹ˆä»»ä½•é—®é¢˜ï¼Œä½†å†…å­˜å§‹ç»ˆä¸å¾—æˆåŠŸé‡Šæ”¾ï¼Œè¿™ä¹Ÿæˆäº†æˆ‘çš„å”¯ä¸€çš„ç–‘æƒ‘ç‚¹ï¼Œå¸Œæœ›èƒ½æœ‰äººä¸ºæˆ‘è§£æƒ‘ï¼Œä¸‡åˆ†æ„Ÿè°¢~

## å‚è€ƒ
* [é‡æŒ‡é’ˆå®šä½](http://sindrilin.com/apm/performance/2017/11/01/é‡æŒ‡é’ˆå®šä½.html)
* [deallocå®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/objectivec/nsobject/1571947-dealloc)
